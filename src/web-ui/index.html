<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Todo Tasks</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: visible;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #4facfe;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #4facfe;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .projects {
            padding: 30px;
        }
        
        .project-section {
            margin-bottom: 40px;
        }
        
        .project-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .project-icon {
            font-size: 1.5rem;
            margin-right: 10px;
        }
        
        .project-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
        }
        
        .project-count {
            background: #4facfe;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-left: 10px;
        }
        
        .todos-grid {
            display: grid;
            gap: 15px;
        }
        
        .todo-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .todo-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .todo-item.completed {
            opacity: 0.7;
            background: #f8f9fa;
        }
        
        .todo-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .todo-status {
            font-size: 1.2rem;
            margin-right: 10px;
        }
        
        .todo-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            flex: 1;
        }
        
        .todo-priority {
            background: #ff6b6b;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .todo-priority.high { background: #ff6b6b; }
        .todo-priority.medium { background: #ffa726; }
        .todo-priority.low { background: #66bb6a; }
        
        .todo-details {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
        }
        
        .detail-section h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .detail-section p {
            margin: 0;
            color: #666;
            line-height: 1.5;
            font-size: 0.9rem;
        }
        
        .detail-toggle {
            cursor: pointer;
            user-select: none;
            margin: 0 0 10px 0;
            color: #333;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .detail-toggle:hover {
            color: #4facfe;
        }
        
        .toggle-icon {
            font-size: 0.8rem;
            transition: transform 0.3s ease;
        }
        
        .detail-content {
            max-height: 200px;
            overflow-y: auto;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            background: #f8f9fa;
        }
        
        .detail-content.collapsed {
            max-height: 0;
            opacity: 0;
            padding: 0 10px;
            border: none;
        }
        
        .detail-content.expanded {
            max-height: 200px;
            opacity: 1;
        }
        
        .detail-content.expanded .toggle-icon {
            transform: rotate(180deg);
        }
        
        .todo-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .todo-tags {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .todo-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }
        
        .todo-date {
            font-size: 0.8rem;
            color: #999;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #4facfe;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 15px 20px;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
            transition: all 0.3s ease;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.6);
        }
        
        .tools-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            z-index: 1000;
            max-width: 300px;
        }
        
        .tools-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .tool-btn {
            display: block;
            width: 100%;
            background: #4facfe;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }
        
        .tool-btn:hover {
            background: #3d8bfe;
            transform: translateX(5px);
        }
        
        .tool-btn.danger {
            background: #ff6b6b;
        }
        
        .tool-btn.danger:hover {
            background: #ff5252;
        }
        
        .tool-btn.success {
            background: #66bb6a;
        }
        
        .tool-btn.success:hover {
            background: #4caf50;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        /* Confirmation Modal Styles */
        .confirm-modal {
            max-width: 450px;
            text-align: center;
        }
        
        .modal-body {
            padding: 20px 0;
        }
        
        
        .confirm-modal p {
            font-size: 1.1rem;
            color: #555;
            line-height: 1.5;
            margin: 0;
        }
        
        .modal-footer {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }
        
        .cancel-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            min-width: 100px;
        }
        
        .cancel-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }
        
        .confirm-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            min-width: 100px;
        }
        
        .confirm-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }
        
        /* Success/Error Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 3000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 350px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: #28a745;
        }
        
        .notification.error {
            background: #dc3545;
        }
        
        .notification.warning {
            background: #ffc107;
            color: #333;
        }
        
        /* Completed Task Compact View */
        .todo-item.completed {
            background: #f8f9fa;
            border-left: 4px solid #28a745;
        }
        
        .todo-item.completed .todo-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
        }
        
        .todo-item.completed .todo-name {
            flex: 1;
            text-decoration: line-through;
            color: #6c757d;
        }
        
        .todo-item.completed .todo-priority {
            font-size: 0.9rem;
            opacity: 0.7;
        }
        
        .expand-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .expand-btn:hover {
            background: #e9ecef;
        }
        
        .expand-icon {
            font-size: 0.8rem;
            transition: transform 0.2s;
        }
        
        .expand-btn.expanded .expand-icon {
            transform: rotate(180deg);
        }
        
        .completed-details {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        
        .completed-details.collapsed {
            display: none;
        }
        
        .completed-details.expanded {
            display: block;
        }
        
        .completed-info {
            margin-bottom: 10px;
        }
        
        .completed-date {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .completed-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .completed-tags .tag {
            background: #e9ecef;
            color: #495057;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8rem;
        }
        
        .completed-actions {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
        }
        
        .completed-actions .action-btn {
            padding: 6px 12px;
            font-size: 0.9rem;
        }
        
        /* AI Guidance Always Open */
        .ai-guidance-header {
            cursor: default !important;
            color: #495057;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .ai-guidance-header:hover {
            background: none !important;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        
        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }
        
        .submit-btn {
            background: #4facfe;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .submit-btn:hover {
            background: #3d8bfe;
            transform: translateY(-2px);
        }
        
        .action-btn {
            background: #4facfe;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 2px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .action-btn.edit {
            background: #ffa726;
        }
        
        .action-btn.complete {
            background: #66bb6a;
        }
        
        .action-btn.delete {
            background: #ff6b6b;
        }
        
        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .project-header {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.3s ease, border-radius 0.3s ease;
            padding: 15px;
            margin: 0;
        }
        
        .project-header:hover {
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .project-toggle {
            font-size: 1.2rem;
            margin-right: 10px;
            transition: transform 0.3s ease;
        }
        
        .project-toggle.expanded {
            transform: rotate(90deg);
        }
        
        .project-todos {
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .project-todos.collapsed {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
        }
        
        .project-todos.expanded {
            max-height: none;
            opacity: 1;
            margin-top: 15px;
        }
        
        .current-project {
            border-left: 4px solid #4facfe;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .current-project .project-header {
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ MCP Todo Tasks</h1>
            <p>Manage your tasks with AI-powered insights</p>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalTodos">0</div>
                <div class="stat-label">Total Tasks</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingTodos">0</div>
                <div class="stat-label">Pending</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completedTodos">0</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completionRate">0%</div>
                <div class="stat-label">Completion Rate</div>
            </div>
        </div>
        
        <div class="tools-panel">
            <div class="tools-title">üõ†Ô∏è MCP Tools</div>
            <button class="tool-btn" onclick="openModal('addModal')">‚ûï Add Task</button>
            <button class="tool-btn" onclick="openModal('listModal')">üìã List Tasks</button>
            <button class="tool-btn" onclick="openModal('markDoneModal')">‚úÖ Mark Done</button>
            <button class="tool-btn danger" onclick="openModal('removeModal')">üóëÔ∏è Remove Task</button>
            <button class="tool-btn danger" onclick="clearAllTasks()">üßπ Clear All</button>
            <button class="tool-btn success" onclick="analyzeTasks()">ü§ñ AI Analyze</button>
            <button class="tool-btn" onclick="openModal('projectModal')">üìÅ Set Project</button>
        </div>
        
        <div class="projects" id="projectsContainer">
            <div class="loading">Loading tasks...</div>
        </div>
    </div>
    
    <button class="refresh-btn" onclick="location.reload()">üîÑ Refresh</button>
    
    <!-- Add Task Modal -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Task</h3>
                <button class="close-btn" onclick="closeModal('addModal')">&times;</button>
            </div>
            <form id="addTaskForm">
                <div class="form-group">
                    <label class="form-label">Task Name *</label>
                    <input type="text" class="form-input" name="name" required placeholder="Enter task name">
                </div>
                <div class="form-group">
                    <label class="form-label">Priority (1-10)</label>
                    <select class="form-input" name="priority">
                        <option value="1">1 - Very Low</option>
                        <option value="2">2 - Low</option>
                        <option value="3">3 - Low</option>
                        <option value="4">4 - Low</option>
                        <option value="5" selected>5 - Medium</option>
                        <option value="6">6 - Medium</option>
                        <option value="7">7 - High</option>
                        <option value="8">8 - High</option>
                        <option value="9">9 - Very High</option>
                        <option value="10">10 - Critical</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Tags (comma-separated)</label>
                    <input type="text" class="form-input" name="tags" placeholder="urgent, backend, frontend">
                </div>
                <div class="form-group">
                    <label class="form-label">Detailed Instructions (optional)</label>
                    <textarea class="form-input" name="detailedInstructions" rows="4" placeholder="Enter detailed instructions, technical specifications, requirements, or any additional context for this task..."></textarea>
                </div>
                <button type="submit" class="submit-btn">Add Task</button>
            </form>
        </div>
    </div>
    
    <!-- List Tasks Modal -->
    <div id="listModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">All Tasks</h3>
                <button class="close-btn" onclick="closeModal('listModal')">&times;</button>
            </div>
            <div id="listTasksContent">
                <div class="loading">Loading tasks...</div>
            </div>
        </div>
    </div>
    
    <!-- Mark Done Modal -->
    <div id="markDoneModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Mark Task as Done</h3>
                <button class="close-btn" onclick="closeModal('markDoneModal')">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Select Task</label>
                <select class="form-input" id="markDoneSelect">
                    <option value="">Loading tasks...</option>
                </select>
            </div>
            <button class="submit-btn" onclick="markTaskDoneFromModal()">Mark as Done</button>
        </div>
    </div>
    
    <!-- Remove Task Modal -->
    <div id="removeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Remove Task</h3>
                <button class="close-btn" onclick="closeModal('removeModal')">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Select Task</label>
                <select class="form-input" id="removeSelect">
                    <option value="">Loading tasks...</option>
                </select>
            </div>
            <button class="submit-btn danger" onclick="removeTaskFromModal()">Remove Task</button>
        </div>
    </div>
    
    <!-- Set Project Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Set Project</h3>
                <button class="close-btn" onclick="closeModal('projectModal')">&times;</button>
            </div>
            <form id="projectForm">
                <div class="form-group">
                    <label class="form-label">Project Path *</label>
                    <input type="text" class="form-input" name="path" required placeholder="/path/to/your/project">
                </div>
                <div class="form-group">
                    <label class="form-label">Project Name (optional)</label>
                    <input type="text" class="form-input" name="name" placeholder="My Awesome Project">
                </div>
                <button type="submit" class="submit-btn">Set Project</button>
            </form>
        </div>
    </div>
    
    <!-- Edit Task Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Task</h3>
                <button class="close-btn" onclick="closeModal('editModal')">&times;</button>
            </div>
            <form id="editTaskForm">
                <input type="hidden" id="editTaskId" name="id">
                <div class="form-group">
                    <label class="form-label">Task Name *</label>
                    <input type="text" class="form-input" id="editTaskName" name="name" required placeholder="Enter task name">
                </div>
                <div class="form-group">
                    <label class="form-label">Priority (1-10)</label>
                    <select class="form-input" id="editTaskPriority" name="priority">
                        <option value="1">1 - Critical</option>
                        <option value="2">2 - Very High</option>
                        <option value="3">3 - High</option>
                        <option value="4">4 - High</option>
                        <option value="5">5 - Medium</option>
                        <option value="6">6 - Medium</option>
                        <option value="7">7 - Low</option>
                        <option value="8">8 - Low</option>
                        <option value="9">9 - Very Low</option>
                        <option value="10">10 - Lowest</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Tags (comma-separated)</label>
                    <input type="text" class="form-input" id="editTaskTags" name="tags" placeholder="urgent, backend, frontend">
                </div>
                <div class="form-group">
                    <label class="form-label">Detailed Instructions</label>
                    <textarea class="form-input" id="editTaskInstructions" name="detailedInstructions" rows="4" placeholder="Enter detailed instructions, technical specifications, requirements, or any additional context for this task..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-input" id="editTaskStatus" name="status">
                        <option value="pending">Pending</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                <button type="submit" class="submit-btn">Update Task</button>
            </form>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content confirm-modal">
            <div class="modal-header">
                <h3 class="modal-title" id="confirmTitle">Confirm Action</h3>
                <button class="close-btn" onclick="closeConfirmModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">Are you sure you want to proceed?</p>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn" onclick="closeConfirmModal()" id="confirmCancel">Cancel</button>
                <button class="confirm-btn" onclick="executeConfirmAction()" id="confirmAction">Confirm</button>
            </div>
        </div>
    </div>
    
    <script>
        // API base URL
        const API_BASE = '/api';
        
        // Load tasks on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadTodos();
        });
        
        // Keyboard support for confirmation modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeConfirmModal();
            }
        });
        
        // Add task form handler
        document.getElementById('addTaskForm').addEventListener('submit', function(e) {
            e.preventDefault();
            addTask();
        });
        
        // Project form handler
        document.getElementById('projectForm').addEventListener('submit', function(e) {
            e.preventDefault();
            setProject();
        });
        
        // Edit task form handler
        document.getElementById('editTaskForm').addEventListener('submit', function(e) {
            e.preventDefault();
            updateTask();
        });
        
        // Load todos from API
        async function loadTodos() {
            try {
                const response = await fetch(`${API_BASE}/todos`);
                const data = await response.json();
                
                if (data.success) {
                    updateStats(data.data);
                    await renderTodosWithProjects(data.data.todos);
                } else {
                    showError('Failed to load tasks: ' + data.error);
                }
            } catch (error) {
                showError('Error loading tasks: ' + error.message);
            }
        }
        
        // Add new task
        async function addTask() {
            const form = document.getElementById('addTaskForm');
            const formData = new FormData(form);
            
            const taskData = {
                name: formData.get('name'),
                priority: parseInt(formData.get('priority')),
                tags: formData.get('tags') ? formData.get('tags').split(',').map(tag => tag.trim()) : [],
                detailedInstructions: formData.get('detailedInstructions') || undefined
            };
            
            try {
                const response = await fetch(`${API_BASE}/todos`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(taskData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeModal('addModal');
                    form.reset();
                    loadTodos();
                    showNotification('Task added successfully!', 'success');
                } else {
                    showNotification('Failed to add task: ' + data.error, 'error');
                }
            } catch (error) {
                alert('Error adding task: ' + error.message);
            }
        }
        
        // Mark task as done
        async function markTaskDone(taskId) {
            try {
                const response = await fetch(`${API_BASE}/todos/${taskId}/done`, {
                    method: 'PUT'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    loadTodos();
                    showNotification('Task marked as completed!', 'success');
                } else {
                    showNotification('Failed to mark task as done: ' + data.error, 'error');
                }
            } catch (error) {
                alert('Error marking task as done: ' + error.message);
            }
        }
        
        // Remove task
        async function removeTask(taskId) {
            showConfirmModal(
                'Delete Task',
                'Are you sure you want to remove this task? This action cannot be undone.',
                'Delete',
                'Cancel',
                async () => {
                    try {
                        const response = await fetch(`${API_BASE}/todos/${taskId}`, {
                            method: 'DELETE'
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            loadTodos();
                            showNotification('Task removed successfully!', 'success');
                        } else {
                            showNotification('Failed to remove task: ' + data.error, 'error');
                        }
                    } catch (error) {
                        showError('Error removing task: ' + error.message);
                    }
                }
            );
        }
        
        // Clear all tasks
        async function clearAllTasks() {
            showConfirmModal(
                'Clear All Tasks',
                'Are you sure you want to clear all tasks? This action cannot be undone and will remove all tasks from the current project.',
                'Clear All',
                'Cancel',
                async () => {
                    try {
                        const response = await fetch(`${API_BASE}/todos`, {
                            method: 'DELETE'
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            loadTodos();
                            showNotification('All tasks cleared successfully!', 'success');
                        } else {
                            showNotification('Failed to clear tasks: ' + data.error, 'error');
                        }
                    } catch (error) {
                        showError('Error clearing tasks: ' + error.message);
                    }
                }
            );
        }
        
        // AI Analyze tasks
        async function analyzeTasks() {
            try {
                const response = await fetch(`${API_BASE}/todos/analyze`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show detailed analysis in a modal
                    showAnalysisModal(data.data.analysis, data.data.updatedTodos);
                    
                    // Refresh todos to show updated priorities and tags
                    if (data.data.updatedTodos && data.data.updatedTodos.length > 0) {
                        loadTodos();
                    }
                } else {
                    alert('Failed to analyze tasks: ' + data.error);
                }
            } catch (error) {
                alert('Error analyzing tasks: ' + error.message);
            }
        }
        
        // Show analysis modal
        function showAnalysisModal(analysis, updatedTodos) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3 class="modal-title">ü§ñ AI Analysis Results</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <pre style="white-space: pre-wrap; font-family: monospace; background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 10px 0;">${analysis}</pre>
                        ${updatedTodos && updatedTodos.length > 0 ? `
                            <div style="margin-top: 20px;">
                                <h4>üìù Updated Tasks:</h4>
                                <ul>
                                    ${updatedTodos.map(todo => `
                                        <li>
                                            <strong>${todo.name}</strong>
                                            ${todo.priority ? ` - Priority: ${todo.priority}` : ''}
                                            ${todo.tags && todo.tags.length > 0 ? ` - Tags: ${todo.tags.join(', ')}` : ''}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                    <div class="modal-footer">
                        <button class="submit-btn" onclick="this.closest('.modal').remove()">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Set project
        async function setProject() {
            const form = document.getElementById('projectForm');
            const formData = new FormData(form);
            
            const projectData = {
                path: formData.get('path'),
                name: formData.get('name') || undefined
            };
            
            try {
                const response = await fetch(`${API_BASE}/project`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(projectData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeModal('projectModal');
                    form.reset();
                    alert('Project set successfully: ' + (data.data?.name || data.data?.path));
                    loadTodos(); // Refresh to show new project
                } else {
                    alert('Failed to set project: ' + data.error);
                }
            } catch (error) {
                alert('Error setting project: ' + error.message);
            }
        }
        
        // Edit task
        async function editTask(taskId) {
            try {
                // Get current todos to find the task
                const response = await fetch(`${API_BASE}/todos`);
                const data = await response.json();
                
                if (data.success) {
                    const task = data.data.todos.find(t => t.id === taskId);
                    if (task) {
                        // Populate the edit form
                        document.getElementById('editTaskId').value = task.id;
                        document.getElementById('editTaskName').value = task.name;
                        document.getElementById('editTaskPriority').value = task.priority || 5;
                        document.getElementById('editTaskTags').value = task.tags ? task.tags.join(', ') : '';
                        document.getElementById('editTaskInstructions').value = task.detailedInstructions || '';
                        document.getElementById('editTaskStatus').value = task.status;
                        
                        // Show the edit modal
                        openModal('editModal');
                    } else {
                        alert('Task not found');
                    }
                } else {
                    alert('Failed to load task details');
                }
            } catch (error) {
                alert('Error loading task: ' + error.message);
            }
        }
        
        // Update task
        async function updateTask() {
            const form = document.getElementById('editTaskForm');
            const formData = new FormData(form);
            const taskId = formData.get('id');
            
            const taskData = {
                name: formData.get('name'),
                priority: parseInt(formData.get('priority')),
                tags: formData.get('tags') ? formData.get('tags').split(',').map(tag => tag.trim()) : [],
                detailedInstructions: formData.get('detailedInstructions') || undefined,
                status: formData.get('status')
            };
            
            try {
                const response = await fetch(`${API_BASE}/todos/${taskId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(taskData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeModal('editModal');
                    form.reset();
                    loadTodos();
                    alert('Task updated successfully');
                } else {
                    alert('Failed to update task: ' + data.error);
                }
            } catch (error) {
                alert('Error updating task: ' + error.message);
            }
        }
        
        // Toggle detail sections
        function toggleDetail(elementId) {
            const element = document.getElementById(elementId);
            const toggleIcon = element.previousElementSibling.querySelector('.toggle-icon');
            
            if (element.classList.contains('collapsed')) {
                element.classList.remove('collapsed');
                element.classList.add('expanded');
                toggleIcon.textContent = '‚ñ≤';
            } else {
                element.classList.remove('expanded');
                element.classList.add('collapsed');
                toggleIcon.textContent = '‚ñº';
            }
        }
        
        // Toggle completed task details
        function toggleCompletedDetails(todoId) {
            const details = document.getElementById(`completed-${todoId}`);
            const button = document.getElementById(`expand-${todoId}`);
            const icon = button.querySelector('.expand-icon');
            
            if (details.classList.contains('collapsed')) {
                details.classList.remove('collapsed');
                details.classList.add('expanded');
                button.classList.add('expanded');
                icon.textContent = '‚ñ≤';
            } else {
                details.classList.remove('expanded');
                details.classList.add('collapsed');
                button.classList.remove('expanded');
                icon.textContent = '‚ñº';
            }
        }
        
        // Update statistics
        function updateStats(data) {
            document.getElementById('totalTodos').textContent = data.total || 0;
            document.getElementById('pendingTodos').textContent = data.pending || 0;
            document.getElementById('completedTodos').textContent = data.completed || 0;
            
            const completionRate = data.total > 0 ? Math.round((data.completed / data.total) * 100) : 0;
            document.getElementById('completionRate').textContent = completionRate + '%';
        }
        
        // Render todos with projects
        async function renderTodosWithProjects(todos) {
            const container = document.getElementById('projectsContainer');
            
            if (todos.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìù</div>
                        <h3>No tasks found</h3>
                        <p>Start adding tasks using the MCP tools panel</p>
                    </div>
                `;
                return;
            }
            
            // Fetch projects
            let projects = [];
            try {
                const response = await fetch(`${API_BASE}/projects`);
                const data = await response.json();
                if (data.success) {
                    projects = data.data;
                }
            } catch (error) {
                console.error('Error fetching projects:', error);
            }
            
            // Get current project ID from health endpoint
            let currentProjectId = null;
            try {
                const healthResponse = await fetch(`${API_BASE.replace('/api', '')}/health`);
                const healthData = await healthResponse.json();
                currentProjectId = healthData.projectId;
            } catch (error) {
                console.error('Error fetching current project:', error);
            }
            
            // Group todos by project
            const projectGroups = new Map();
            todos.forEach(todo => {
                const projectId = todo.projectId || 'default';
                if (!projectGroups.has(projectId)) {
                    projectGroups.set(projectId, []);
                }
                projectGroups.get(projectId).push(todo);
            });
            
            // Sort todos within each project: pending first (by priority), then completed
            projectGroups.forEach((projectTodos, projectId) => {
                projectTodos.sort((a, b) => {
                    // First sort by status: pending before completed
                    if (a.status !== b.status) {
                        if (a.status === 'pending') return -1;
                        if (b.status === 'pending') return 1;
                    }
                    // Then sort by priority: lower number = higher priority
                    return a.priority - b.priority;
                });
            });
            
            // Sort projects: current project first, then others
            const sortedProjects = Array.from(projectGroups.entries()).sort(([a], [b]) => {
                if (a === currentProjectId) return -1;
                if (b === currentProjectId) return 1;
                return 0;
            });
            
            container.innerHTML = sortedProjects.map(([projectId, projectTodos], index) => {
                const project = projects.find(p => p.id === projectId);
                const projectName = project ? project.name : `Project ${projectId.substring(0, 8)}...`;
                const projectPath = project ? project.path : 'Unknown';
                const isCurrentProject = projectId === currentProjectId;
                const isExpanded = isCurrentProject; // Current project expanded by default
                
                return `
                    <div class="project-section ${isCurrentProject ? 'current-project' : ''}" data-project-id="${projectId}">
                        <div class="project-header" onclick="toggleProject('${projectId}')">
                            <div class="project-toggle ${isExpanded ? 'expanded' : ''}">‚ñ∂</div>
                            <div class="project-icon">üìÅ</div>
                            <div class="project-title">${projectName}</div>
                            <div class="project-count">${projectTodos.length}</div>
                        </div>
                        <div class="project-path" style="font-size: 0.9rem; color: #666; margin-left: 30px; margin-bottom: 10px;">
                            üìÇ ${projectPath}
                        </div>
                        <div class="project-todos ${isExpanded ? 'expanded' : 'collapsed'}" id="todos-${projectId}">
                            <div class="todos-grid">
                                ${projectTodos.map(todo => `
                                    <div class="todo-item ${todo.status === 'completed' ? 'completed' : ''}">
                                        <div class="todo-header">
                                            <div class="todo-status">${todo.status === 'completed' ? '‚úÖ' : '‚è≥'}</div>
                                            <div class="todo-name">${todo.name}</div>
                                            <div class="todo-priority ${getPriorityClass(todo.priority)}">
                                                Priority ${todo.priority}
                                            </div>
                                            ${todo.status === 'completed' ? `
                                                <button class="expand-btn" onclick="toggleCompletedDetails('${todo.id}')" id="expand-${todo.id}">
                                                    <span class="expand-icon">‚ñº</span>
                                                </button>
                                            ` : ''}
                                        </div>
                                        ${todo.status === 'completed' ? `
                                            <div class="completed-details collapsed" id="completed-${todo.id}">
                                                <div class="completed-info">
                                                    <div class="completed-date">Completed: ${new Date(todo.updatedAt).toLocaleDateString()}</div>
                                                    <div class="completed-tags">
                                                        ${todo.tags && todo.tags.length > 0 ? todo.tags.map(tag => `<span class="tag">${tag}</span>`).join('') : ''}
                                                    </div>
                                                </div>
                                                ${todo.detailedInstructions ? `
                                                    <div class="detail-section">
                                                        <h4 onclick="toggleDetail('instructions-${todo.id}')" class="detail-toggle">
                                                            üìã Detailed Instructions: <span class="toggle-icon">‚ñº</span>
                                                        </h4>
                                                        <div id="instructions-${todo.id}" class="detail-content collapsed">
                                                            <p>${todo.detailedInstructions}</p>
                                                        </div>
                                                    </div>
                                                ` : ''}
                                                ${todo.aiGuidance ? `
                                                    <div class="detail-section">
                                                        <h4 class="detail-toggle ai-guidance-header">
                                                            ü§ñ AI Guidance:
                                                        </h4>
                                                        <div id="ai-${todo.id}" class="detail-content expanded">
                                                            <p>${todo.aiGuidance}</p>
                                                        </div>
                                                    </div>
                                                ` : ''}
                                                <div class="completed-actions">
                                                    <button class="action-btn edit" onclick="editTask('${todo.id}')">‚úèÔ∏è Edit</button>
                                                    <button class="action-btn delete" onclick="removeTask('${todo.id}')">üóëÔ∏è Delete</button>
                                                </div>
                                            </div>
                                        ` : ''}
                                        ${todo.status !== 'completed' && todo.detailedInstructions ? `
                                        <div class="todo-details">
                                            <div class="detail-section">
                                                <h4 onclick="toggleDetail('instructions-${todo.id}')" class="detail-toggle">
                                                    üìã Detailed Instructions: <span class="toggle-icon">‚ñº</span>
                                                </h4>
                                                <div id="instructions-${todo.id}" class="detail-content collapsed">
                                                    <p>${todo.detailedInstructions}</p>
                                                </div>
                                            </div>
                                        </div>
                                        ` : ''}
                                        ${todo.status !== 'completed' && todo.aiGuidance ? `
                                        <div class="todo-details">
                                            <div class="detail-section">
                                                <h4 class="detail-toggle ai-guidance-header">
                                                    ü§ñ AI Guidance:
                                                </h4>
                                                <div id="guidance-${todo.id}" class="detail-content expanded">
                                                    <p>${todo.aiGuidance}</p>
                                                </div>
                                            </div>
                                        </div>
                                        ` : ''}
                                        ${todo.status !== 'completed' ? `
                                        <div class="todo-meta">
                                            <div class="todo-tags">
                                                ${todo.tags.map(tag => `<span class="todo-tag">${tag}</span>`).join('')}
                                            </div>
                                            <div class="todo-date">
                                                Created: ${new Date(todo.createdAt).toLocaleDateString()}
                                            </div>
                                        </div>
                                        <div class="todo-actions">
                                            <button class="action-btn edit" onclick="editTask('${todo.id}')">‚úèÔ∏è Edit</button>
                                            <button class="action-btn complete" onclick="markTaskDone('${todo.id}')">‚úÖ Done</button>
                                            <button class="action-btn delete" onclick="removeTask('${todo.id}')">üóëÔ∏è Delete</button>
                                        </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Toggle project expansion
        function toggleProject(projectId) {
            const projectSection = document.querySelector(`[data-project-id="${projectId}"]`);
            const toggle = projectSection.querySelector('.project-toggle');
            const todos = projectSection.querySelector('.project-todos');
            
            if (todos.classList.contains('expanded')) {
                todos.classList.remove('expanded');
                todos.classList.add('collapsed');
                toggle.classList.remove('expanded');
            } else {
                todos.classList.remove('collapsed');
                todos.classList.add('expanded');
                toggle.classList.add('expanded');
            }
        }
        
        // Get priority class (1 = highest priority, 10 = lowest priority)
        function getPriorityClass(priority) {
            if (priority <= 3) return 'high';
            if (priority <= 6) return 'medium';
            return 'low';
        }
        
        // Show error message
        function showError(message) {
            const container = document.getElementById('projectsContainer');
            container.innerHTML = `<div class="error">${message}</div>`;
        }
        
        // Confirmation modal functions
        let confirmAction = null;
        
        function showConfirmModal(title, message, confirmText, cancelText, action) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmAction').textContent = confirmText;
            document.getElementById('confirmCancel').textContent = cancelText;
            confirmAction = action;
            document.getElementById('confirmModal').style.display = 'block';
        }
        
        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
            confirmAction = null;
        }
        
        function executeConfirmAction() {
            if (confirmAction) {
                confirmAction();
            }
            closeConfirmModal();
        }
        
        // Notification functions
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Show notification
            setTimeout(() => notification.classList.add('show'), 100);
            
            // Hide notification after 3 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            
            // Load tasks for select modals
            if (modalId === 'markDoneModal' || modalId === 'removeModal') {
                loadTasksForSelect(modalId);
            } else if (modalId === 'listModal') {
                loadTasksForList();
            }
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // Load tasks for select dropdowns
        async function loadTasksForSelect(modalId) {
            try {
                const response = await fetch(`${API_BASE}/todos`);
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById(modalId === 'markDoneModal' ? 'markDoneSelect' : 'removeSelect');
                    select.innerHTML = '<option value="">Select a task...</option>';
                    
                    data.data.todos.forEach(todo => {
                        const option = document.createElement('option');
                        option.value = todo.id;
                        option.textContent = `${todo.name} (Priority: ${todo.priority})`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading tasks for select:', error);
            }
        }
        
        // Load tasks for list modal
        async function loadTasksForList() {
            try {
                const response = await fetch(`${API_BASE}/todos`);
                const data = await response.json();
                
                if (data.success) {
                    const container = document.getElementById('listTasksContent');
                    if (data.data.todos.length === 0) {
                        container.innerHTML = '<div class="empty-state">No tasks found</div>';
                    } else {
                        container.innerHTML = data.data.todos.map(todo => `
                            <div class="todo-item ${todo.status === 'completed' ? 'completed' : ''}">
                                <div class="todo-header">
                                    <div class="todo-status">${todo.status === 'completed' ? '‚úÖ' : '‚è≥'}</div>
                                    <div class="todo-name">${todo.name}</div>
                                    <div class="todo-priority ${getPriorityClass(todo.priority)}">
                                        Priority ${todo.priority}
                                    </div>
                                </div>
                                <div class="todo-meta">
                                    <div class="todo-tags">
                                        ${todo.tags.map(tag => `<span class="todo-tag">${tag}</span>`).join('')}
                                    </div>
                                    <div class="todo-date">
                                        Created: ${new Date(todo.createdAt).toLocaleDateString()}
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading tasks for list:', error);
            }
        }
        
        // Mark task done from modal
        function markTaskDoneFromModal() {
            const select = document.getElementById('markDoneSelect');
            const taskId = select.value;
            
            if (taskId) {
                markTaskDone(taskId);
                closeModal('markDoneModal');
            } else {
                alert('Please select a task');
            }
        }
        
        // Remove task from modal
        function removeTaskFromModal() {
            const select = document.getElementById('removeSelect');
            const taskId = select.value;
            
            if (taskId) {
                removeTask(taskId);
                closeModal('removeModal');
            } else {
                alert('Please select a task');
            }
        }
        
        // Auto-refresh every 30 seconds
        setInterval(loadTodos, 30000);
    </script>
</body>
</html>